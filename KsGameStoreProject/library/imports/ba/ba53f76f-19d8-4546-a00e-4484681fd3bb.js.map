{"version":3,"sources":["../../../../../../assets/scripts/Common/Tool/assets/scripts/Common/Tool/PreDownloadMp3Util.js"],"names":["require","RequestTaskFactory","Task_Type","PreDownloadMp3Util","audioURLList","preCompleteCallback","progressCallback","_preDownloadURLList","_progerssCallback","_currentPreDownloadIndex","_currentPreDownloadSubIndex","_currentPreDownloadAudioList","_finishDownloadAudioFilePathList","_dirPath","jsb","fileUtils","getWritablePath","cc","ss","GlobalConst","AUDIO_CACHE_PATH","_completeCallback","_downloadMp3LocalPathList","_currentDownloadCompleteNum","_totalDownloadFileNum","i","audioItem","j","_requestQuestionAudios","length","_preDownloadAudios","push","audioURL","task","createTask","Audio","filePath","setTimeout","doDownload","module","exports"],"mappings":";;;;;;;;;;AAAA;;;;eAIwCA,QAAQ,oBAAR;IAAjCC,8BAAAA;IAAoBC,qBAAAA;;IACrBC;AAEF;;;;;;AAMA,gCAAYC,YAAZ,EAA0BC,mBAA1B,EACA;AAAA,YAD+CC,gBAC/C,uEADkE,IAClE;;AAAA;;AACI,aAAKC,mBAAL,GAA2BH,YAA3B;AACA,aAAKI,iBAAL,GAAyBF,gBAAzB;;AAEA,aAAKG,wBAAL,GAAgC,CAAhC;;AAEA,aAAKC,2BAAL,GAAmC,CAAnC;AACA,aAAKC,4BAAL,GAAoC,EAApC;;AAEA,aAAKC,gCAAL,GAAwC,EAAxC;;AAEA,aAAKC,QAAL,GAAiBC,IAAIC,SAAJ,CAAcC,eAAd,KAAkCC,GAAGC,EAAH,CAAMC,WAAN,CAAkBC,gBAArE;AACA,aAAKC,iBAAL,GAAyBhB,mBAAzB;;AAEA,aAAKiB,yBAAL,GAAiC,EAAjC;;AAEA,aAAKC,2BAAL,GAAmC,CAAnC;;AAEA,aAAKC,qBAAL,GAA6B,CAA7B;AACH;;;;2CAGD;AACI,iBAAKD,2BAAL,GAAmC,CAAnC;AACA,iBAAKC,qBAAL,GAA6B,CAA7B;;AAEA,iBAAK,IAAIC,CAAT,IAAc,KAAKlB,mBAAnB,EACA;AACI,oBAAImB,YAAY,KAAKnB,mBAAL,CAAyBkB,CAAzB,CAAhB;AACA,qBAAK,IAAIE,CAAT,IAAcD,SAAd,EAAyB;AAAE,yBAAKF,qBAAL;AAA+B;AAC7D;;AAED,iBAAKf,wBAAL,GAAgC,CAAhC;AACA,iBAAKmB,sBAAL;AACH;;;iDAGD;AACI,gBAAI,KAAKnB,wBAAL,IAAiC,KAAKF,mBAAL,CAAyBsB,MAA9D,EAAsE;AAClE,qBAAKR,iBAAL,CAAuB,KAAKC,yBAA5B;AACA;AACH;;AAED,iBAAKX,4BAAL,GAAoC,KAAKJ,mBAAL,CAAyB,KAAKE,wBAA9B,CAApC;AACA,iBAAKC,2BAAL,GAAmC,CAAnC;AACA,iBAAKE,gCAAL,GAAwC,EAAxC;;AAEA,iBAAKkB,kBAAL;AACH;;;6CAGD;AAAA;;AACI,gBAAI,KAAKpB,2BAAL,IAAoC,KAAKC,4BAAL,CAAkCkB,MAA1E,EAAkF;AAC9E,qBAAKP,yBAAL,CAA+BS,IAA/B,CAAoC,KAAKnB,gCAAzC;;AAEA,qBAAKH,wBAAL;AACA,qBAAKmB,sBAAL;AACA;AACH;AACD,gBAAII,WAAW,KAAKrB,4BAAL,CAAkC,KAAKD,2BAAvC,CAAf;AACA,gBAAIuB,OAAOhC,mBAAmBiC,UAAnB,CAA8BhC,UAAUiC,KAAxC,EAA+CH,QAA/C,EAAyD,KAAKnB,QAA9D,EAAwE,UAACuB,QAAD,EAAc;AAC7F,sBAAKxB,gCAAL,CAAsCmB,IAAtC,CAA2CK,QAA3C;AACA,sBAAK1B,2BAAL;AACA,sBAAKa,2BAAL;AACA,oBAAI,MAAKf,iBAAT,EAA4B,MAAKA,iBAAL,CAAuB,MAAKe,2BAA5B,EAAyD,MAAKC,qBAA9D;;AAE5Ba,2BAAW,YAAM;AAAC;AACd,0BAAKP,kBAAL;AACH,iBAFD,EAEG,EAFH;AAGH,aATU,CAAX;;AAWAG,iBAAKK,UAAL;AACH;;;;KAGJ;;AAEDC,OAAOC,OAAP,GAAiBrC,kBAAjB","file":"PreDownloadMp3Util.js","sourceRoot":"../../../../../../assets/scripts/Common/Tool","sourcesContent":["/**\n * Mp3预下载工具\n */\n\nconst {RequestTaskFactory, Task_Type} = require('RequestTaskFactory');\nclass PreDownloadMp3Util\n{\n    /**\n     *\n     * @param audioURLList 预加载音频url数组\n     * @param preCompleteCallback 完成回调\n     * @param progressCallback\n     */\n    constructor(audioURLList, preCompleteCallback, progressCallback = null)\n    {\n        this._preDownloadURLList = audioURLList;\n        this._progerssCallback = progressCallback;\n\n        this._currentPreDownloadIndex = 0;\n\n        this._currentPreDownloadSubIndex = 0;\n        this._currentPreDownloadAudioList = [];\n\n        this._finishDownloadAudioFilePathList = [];\n\n        this._dirPath =  jsb.fileUtils.getWritablePath() + cc.ss.GlobalConst.AUDIO_CACHE_PATH;\n        this._completeCallback = preCompleteCallback;\n\n        this._downloadMp3LocalPathList = [];\n\n        this._currentDownloadCompleteNum = 0;\n\n        this._totalDownloadFileNum = 0;\n    }\n\n    startPreDownload()\n    {\n        this._currentDownloadCompleteNum = 0;\n        this._totalDownloadFileNum = 0;\n\n        for (let i in this._preDownloadURLList)\n        {\n            let audioItem = this._preDownloadURLList[i];\n            for (let j in audioItem) { this._totalDownloadFileNum++; }\n        }\n\n        this._currentPreDownloadIndex = 0;\n        this._requestQuestionAudios();\n    }\n\n    _requestQuestionAudios()\n    {\n        if (this._currentPreDownloadIndex >= this._preDownloadURLList.length) {\n            this._completeCallback(this._downloadMp3LocalPathList);\n            return;\n        }\n\n        this._currentPreDownloadAudioList = this._preDownloadURLList[this._currentPreDownloadIndex];\n        this._currentPreDownloadSubIndex = 0;\n        this._finishDownloadAudioFilePathList = [];\n\n        this._preDownloadAudios();\n    }\n\n    _preDownloadAudios()\n    {\n        if (this._currentPreDownloadSubIndex >= this._currentPreDownloadAudioList.length) {\n            this._downloadMp3LocalPathList.push(this._finishDownloadAudioFilePathList);\n\n            this._currentPreDownloadIndex++;\n            this._requestQuestionAudios();\n            return;\n        }\n        let audioURL = this._currentPreDownloadAudioList[this._currentPreDownloadSubIndex];\n        let task = RequestTaskFactory.createTask(Task_Type.Audio, audioURL, this._dirPath, (filePath) => {\n            this._finishDownloadAudioFilePathList.push(filePath);\n            this._currentPreDownloadSubIndex++;\n            this._currentDownloadCompleteNum++;\n            if (this._progerssCallback) this._progerssCallback(this._currentDownloadCompleteNum, this._totalDownloadFileNum);\n\n            setTimeout(() => {//延时0.05秒移动到开始下一轮\n                this._preDownloadAudios();\n            }, 50);\n        });\n\n        task.doDownload();\n    }\n\n\n}//end class\n\nmodule.exports = PreDownloadMp3Util;\n"]}