{"version":3,"sources":["../../../../../../../../assets/scripts/GameModule/Base/Module/View/assets/scripts/GameModule/Base/Module/View/HeadIcon.js"],"names":["Controller","require","RequestTaskFactory","Task_Type","SceneMgr","cc","Class","extends","properties","buttonSfx","AudioClip","lifeHeartTexture","Texture2D","lifeHeartNoneTexture","_clickCallback","getHandleNotificationList","ss","TagConst","TAG_REFRESH_HEAD_ICON_INFO","TAG_REFRESH_HEAD_ICON_STAR_INFO","TAG_LIFE_SYSTEM_COMPLETE_COUNT_DOWN","TAG_LIFE_SYSTEM_START_COUNT_DOWN","TAG_LIFE_SYSTEM_COUNT_DOWN_TIME","TAG_LIFE_SYSTEM_UPDATE_LIFE","onNotification","notification","name","getName","body","getBody","_initUIByData","_setupStarNum","_onHandleCountDownComplete","_onHandleCountDownStart","_onHandleCountDownTimeUpdate","_onHandleUpdateLife","_setCountTimeLabel","lifeSystemMgr","getNowCountDownSecs","find","node","active","_convertSecsToTime","secs","parseInt","minute","second","time","getComponent","Label","string","stringUtil","prefixInteger","_setupLife","_loadHeadIcon","headIconURL","headSprite","srcWidth","width","srcHeight","height","opacity","dirPath","jsb","fileUtils","getWritablePath","GlobalConst","IMAGE_CACHE_PATH","task","createTask","Image","tex","filePath","Sprite","spriteFrame","SpriteFrame","runAction","fadeTo","doDownload","onLoad","setControllerName","NameConst","NAME_CONTROLLER_HEAD_ICON","Facade","registerController","_bindClickEvent","_setupHeadIcon","_setupTime","lifeNum","getLife","lifeHeartList","getChildren","forEach","heartSp","i","starCount","userInfoCache","userStarNum","undefined","isCountingDown","headBgSpriteBtn","getChildByName","on","event","localStorage","isSoundOpen","userId","audioUtil","playSfx","onDestroy","removeController"],"mappings":";;;;;;AAAA,IAAMA,aAAaC,QAAQ,YAAR,CAAnB;;eACwCA,QAAQ,oBAAR;IAAjCC,8BAAAA;IAAoBC,qBAAAA;;AAC3B,IAAMC,WAAWH,QAAQ,UAAR,CAAjB;;AAEAI,GAAGC,KAAH,CAAS;AACLC,aAASP,UADJ;;AAGLQ,gBAAY;AACRC,mBAAYJ,GAAGK,SADP,EACkB;AAC1BC,0BAAoBN,GAAGO,SAFf;AAGRC,8BAAwBR,GAAGO,SAHnB;AAIRE,wBAAiB;AAJT,KAHP;;AAULC,+BAA4B,qCAAW;AACnC,eAAO,CACHV,GAAGW,EAAH,CAAMC,QAAN,CAAeC,0BADZ,EAEHb,GAAGW,EAAH,CAAMC,QAAN,CAAeE,+BAFZ,EAGHd,GAAGW,EAAH,CAAMC,QAAN,CAAeG,mCAHZ,EAIHf,GAAGW,EAAH,CAAMC,QAAN,CAAeI,gCAJZ,EAKHhB,GAAGW,EAAH,CAAMC,QAAN,CAAeK,+BALZ,EAMHjB,GAAGW,EAAH,CAAMC,QAAN,CAAeM,2BANZ,CAAP;AAQH,KAnBI;;AAqBLC,oBAAiB,wBAASC,YAAT,EAAuB;AACpC,YAAIC,OAAOD,aAAaE,OAAb,EAAX;AACA,YAAIC,OAAOH,aAAaI,OAAb,EAAX;AACA,YAAGH,SAASrB,GAAGW,EAAH,CAAMC,QAAN,CAAeC,0BAA3B,EAAsD;AAAC;AACnD,iBAAKY,aAAL;AACH,SAFD,MAEM,IAAIJ,SAASrB,GAAGW,EAAH,CAAMC,QAAN,CAAeE,+BAA5B,EAA4D;AAC9D,iBAAKY,aAAL;AAEH,SAHK,MAGA,IAAIL,SAASrB,GAAGW,EAAH,CAAMC,QAAN,CAAeG,mCAA5B,EAAgE;AAClE,iBAAKY,0BAAL;AAEH,SAHK,MAGA,IAAIN,SAASrB,GAAGW,EAAH,CAAMC,QAAN,CAAeI,gCAA5B,EAA6D;AAC/D,iBAAKY,uBAAL;AAEH,SAHK,MAGA,IAAIP,SAASrB,GAAGW,EAAH,CAAMC,QAAN,CAAeK,+BAA5B,EAA4D;AAC9D,iBAAKY,4BAAL,CAAkCN,IAAlC;AAEH,SAHK,MAGA,IAAIF,SAASrB,GAAGW,EAAH,CAAMC,QAAN,CAAeM,2BAA5B,EAAwD;AAC1D,iBAAKY,mBAAL;AACH;AACJ,KAzCI;;AA4CLF,2BA5CK,qCA6CL;AACI,aAAKG,kBAAL,CAAwB/B,GAAGW,EAAH,CAAMqB,aAAN,CAAoBC,mBAApB,EAAxB;AACAjC,WAAGkC,IAAH,CAAQ,QAAR,EAAkB,KAAKC,IAAvB,EAA6BC,MAA7B,GAAsC,IAAtC;AACH,KAhDI;AAkDLT,8BAlDK,wCAmDL;AACI3B,WAAGkC,IAAH,CAAQ,QAAR,EAAkB,KAAKC,IAAvB,EAA6BC,MAA7B,GAAsC,KAAtC;AACH,KArDI;AAuDLC,sBAvDK,8BAuDcC,IAvDd,EAwDL;AACIA,eAAOC,SAASD,IAAT,IAAiB,IAAxB;;AAEA,YAAIE,SAASD,SAASD,OAAO,EAAhB,CAAb;AACA,YAAIG,SAASH,OAAO,EAApB;;AAEA,eAAO,EAACE,QAASA,MAAV,EAAkBC,QAASA,MAA3B,EAAP;AACH,KA/DI;AAiELV,sBAjEK,8BAiEcO,IAjEd,EAkEL;AACI,YAAII,OAAO,KAAKL,kBAAL,CAAwBC,IAAxB,CAAX;;AAEAtC,WAAGkC,IAAH,CAAQ,kBAAR,EAA4B,KAAKC,IAAjC,EAAuCQ,YAAvC,CAAoD3C,GAAG4C,KAAvD,EAA8DC,MAA9D,GAA0E7C,GAAGW,EAAH,CAAMmC,UAAN,CAAiBC,aAAjB,CAA+BL,KAAKF,MAApC,EAA4C,CAA5C,CAA1E,SAA4HxC,GAAGW,EAAH,CAAMmC,UAAN,CAAiBC,aAAjB,CAA+BL,KAAKD,MAApC,EAA4C,CAA5C,CAA5H;AACH,KAtEI;AAwELZ,gCAxEK,wCAwEwBS,IAxExB,EAyEL;AACI,aAAKP,kBAAL,CAAwBO,IAAxB;AACH,KA3EI;AA8ELR,uBA9EK,iCA+EL;AACI,aAAKkB,UAAL;AACH,KAjFI;AAmFLC,iBAnFK,yBAmFSC,WAnFT,EAoFL;AACI,YAAIC,aAAanD,GAAGkC,IAAH,CAAQ,oCAAR,EAA8C,KAAKC,IAAnD,CAAjB;AACA,YAAIiB,WAAYD,WAAWE,KAA3B;AACA,YAAIC,YAAaH,WAAWI,MAA5B;AACAJ,mBAAWK,OAAX,GAAqB,CAArB;;AAEA,YAAIC,UAAWC,IAAIC,SAAJ,CAAcC,eAAd,KAAkC5D,GAAGW,EAAH,CAAMkD,WAAN,CAAkBC,gBAAnE;AACA,YAAIC,OAAOlE,mBAAmBmE,UAAnB,CAA8BlE,UAAUmE,KAAxC,EAA+Cf,WAA/C,EAA4DO,OAA5D,EAAqE,UAACS,GAAD,EAAMC,QAAN,EAAmB;AAC/F,gBAAID,GAAJ,EACA;AACIf,2BAAWR,YAAX,CAAwB3C,GAAGoE,MAA3B,EAAmCC,WAAnC,GAAiD,IAAIrE,GAAGsE,WAAP,CAAmBJ,GAAnB,CAAjD;AACAf,2BAAWE,KAAX,GAAmBD,QAAnB;AACAD,2BAAWI,MAAX,GAAoBD,SAApB;;AAEAH,2BAAWoB,SAAX,CAAqBvE,GAAGwE,MAAH,CAAU,GAAV,EAAe,GAAf,CAArB;AACH;AACJ,SATU,CAAX;;AAWAT,aAAKU,UAAL;AACH,KAvGI;;;AAyGLC,YAAQ,kBAAY;AAChB,aAAKC,iBAAL,CAAuB3E,GAAGW,EAAH,CAAMiE,SAAN,CAAgBC,yBAAvC;AACA7E,WAAGW,EAAH,CAAMmE,MAAN,CAAaC,kBAAb,CAAgC,IAAhC;;AAEA,aAAKC,eAAL;AACA,aAAKvD,aAAL;AACH,KA/GI;;AAiHLA,iBAjHK,2BAkHL;AACI,aAAKuB,UAAL,GADJ,CACuB;;AAEnB,aAAKtB,aAAL,GAHJ,CAG0B;;AAEtB,aAAKuD,cAAL,GALJ,CAK2B;;AAEvB,aAAKC,UAAL,GAPJ,CAOuB;AACtB,KA1HI;AA4HLlC,cA5HK,wBA6HL;AAAA;;AACI,YAAImC,UAAUnF,GAAGW,EAAH,CAAMqB,aAAN,CAAoBoD,OAApB,EAAd;AACA,YAAIC,gBAAgBrF,GAAGkC,IAAH,CAAQ,qBAAR,EAA+B,KAAKC,IAApC,EAA0CmD,WAA1C,EAApB;AACAH,kBAAUA,UAAU,CAAV,GAAc,CAAd,GAAkBA,OAA5B;;AAEAE,sBAAcE,OAAd,CAAsB,UAACC,OAAD,EAAa;AAAEA,oBAAQ7C,YAAR,CAAqB3C,GAAGoE,MAAxB,EAAgCC,WAAhC,GAA8C,IAAIrE,GAAGsE,WAAP,CAAmB,MAAK9D,oBAAxB,CAA9C;AAA8F,SAAnI;;AAEA,aAAK,IAAIiF,IAAI,CAAb,EAAgBA,IAAIN,OAApB,EAA6BM,GAA7B;AAAkCJ,0BAAcI,CAAd,EAAiB9C,YAAjB,CAA8B3C,GAAGoE,MAAjC,EAAyCC,WAAzC,GAAuD,IAAIrE,GAAGsE,WAAP,CAAmB,KAAKhE,gBAAxB,CAAvD;AAAlC;AACH,KArII;AAuILoB,iBAvIK,2BAwIL;AACI,YAAIgE,YAAY1F,GAAGW,EAAH,CAAMgF,aAAN,CAAoBC,WAApC;AACA5F,WAAGkC,IAAH,CAAQ,sBAAR,EAAgC,KAAKC,IAArC,EAA2CQ,YAA3C,CAAwD3C,GAAG4C,KAA3D,EAAkEC,MAAlE,GAA4E6C,YAAY,SAAb,GAA0B,YAA1B,GAAyCA,SAApH;AACH,KA3II;AA6ILT,kBA7IK,4BA8IL;AACI,YAAI/B,cAAclD,GAAGW,EAAH,CAAMgF,aAAN,CAAoBzC,WAAtC;AACA,YAAIA,gBAAgB,EAAhB,IAAsBA,gBAAgB2C,SAAtC,IAAmD3C,gBAAgB,WAAvE,EAAoF,KAAKD,aAAL,CAAmBC,WAAnB;AACvF,KAjJI;AAmJLgC,cAnJK,wBAoJL;AACI,YAAIY,iBAAiB9F,GAAGW,EAAH,CAAMqB,aAAN,CAAoB8D,cAApB,EAArB;AACA9F,WAAGkC,IAAH,CAAQ,QAAR,EAAkB,KAAKC,IAAvB,EAA6BC,MAA7B,GAAsC0D,cAAtC;;AAEA,YAAIA,cAAJ,EAAoB,KAAK/D,kBAAL,CAAwB/B,GAAGW,EAAH,CAAMqB,aAAN,CAAoBC,mBAApB,EAAxB;AACvB,KAzJI;AA2JL+C,mBA3JK,6BA4JL;AAAA;;AACI,YAAIe,kBAAkB,KAAK5D,IAAL,CAAU6D,cAAV,CAAyB,iBAAzB,CAAtB;AACAD,wBAAgBE,EAAhB,CAAmB,OAAnB,EAA4B,UAACC,KAAD,EAAW;AACnC,gBAAI,OAAKzF,cAAT,EAAwB;AACpB,uBAAKA,cAAL;AACA,oBAAIT,GAAGW,EAAH,CAAMwF,YAAN,CAAmBC,WAAnB,CAA+BpG,GAAGW,EAAH,CAAMgF,aAAN,CAAoBU,MAAnD,CAAJ,EAAgErG,GAAGW,EAAH,CAAM2F,SAAN,CAAgBC,OAAhB,CAAwB,OAAKnG,SAA7B;AACnE;AACJ,SALD;AAMH,KApKI;;;AAsKLoG,eAAW,qBAAW;AAClBxG,WAAGW,EAAH,CAAMmE,MAAN,CAAa2B,gBAAb,CAA8B,IAA9B;AACH;;AAxKI,CAAT","file":"HeadIcon.js","sourceRoot":"../../../../../../../../assets/scripts/GameModule/Base/Module/View","sourcesContent":["const Controller = require('Controller');\nconst {RequestTaskFactory, Task_Type} = require('RequestTaskFactory');\nconst SceneMgr = require('SceneMgr');\n\ncc.Class({\n    extends: Controller,\n\n    properties: {\n        buttonSfx : cc.AudioClip, //btn sfx\n        lifeHeartTexture :  cc.Texture2D,\n        lifeHeartNoneTexture :  cc.Texture2D,\n        _clickCallback : null,\n    },\n\n    getHandleNotificationList : function() {\n        return [\n            cc.ss.TagConst.TAG_REFRESH_HEAD_ICON_INFO,\n            cc.ss.TagConst.TAG_REFRESH_HEAD_ICON_STAR_INFO,\n            cc.ss.TagConst.TAG_LIFE_SYSTEM_COMPLETE_COUNT_DOWN,\n            cc.ss.TagConst.TAG_LIFE_SYSTEM_START_COUNT_DOWN,\n            cc.ss.TagConst.TAG_LIFE_SYSTEM_COUNT_DOWN_TIME,\n            cc.ss.TagConst.TAG_LIFE_SYSTEM_UPDATE_LIFE,\n        ];\n    },\n\n    onNotification : function(notification) {\n        let name = notification.getName();\n        let body = notification.getBody();\n        if(name === cc.ss.TagConst.TAG_REFRESH_HEAD_ICON_INFO){//刷新数据\n            this._initUIByData();\n        }else if (name === cc.ss.TagConst.TAG_REFRESH_HEAD_ICON_STAR_INFO){\n            this._setupStarNum();\n\n        }else if (name === cc.ss.TagConst.TAG_LIFE_SYSTEM_COMPLETE_COUNT_DOWN){\n            this._onHandleCountDownComplete();\n\n        }else if (name === cc.ss.TagConst.TAG_LIFE_SYSTEM_START_COUNT_DOWN){\n            this._onHandleCountDownStart();\n\n        }else if (name === cc.ss.TagConst.TAG_LIFE_SYSTEM_COUNT_DOWN_TIME){\n            this._onHandleCountDownTimeUpdate(body);\n\n        }else if (name === cc.ss.TagConst.TAG_LIFE_SYSTEM_UPDATE_LIFE){\n            this._onHandleUpdateLife();\n        }\n    },\n\n\n    _onHandleCountDownStart()\n    {\n        this._setCountTimeLabel(cc.ss.lifeSystemMgr.getNowCountDownSecs());\n        cc.find('timeBg', this.node).active = true;\n    },\n\n    _onHandleCountDownComplete()\n    {\n        cc.find('timeBg', this.node).active = false;\n    },\n\n    _convertSecsToTime(secs)\n    {\n        secs = parseInt(secs) / 1000;\n\n        let minute = parseInt(secs / 60);\n        let second = secs % 60;\n\n        return {minute : minute, second : second};\n    },\n\n    _setCountTimeLabel(secs)\n    {\n        let time = this._convertSecsToTime(secs);\n\n        cc.find('timeBg/timeLabel', this.node).getComponent(cc.Label).string = `${cc.ss.stringUtil.prefixInteger(time.minute, 2)}:${cc.ss.stringUtil.prefixInteger(time.second, 2)}`;\n    },\n\n    _onHandleCountDownTimeUpdate(secs)\n    {\n        this._setCountTimeLabel(secs);\n    },\n\n\n    _onHandleUpdateLife()\n    {\n        this._setupLife();\n    },\n\n    _loadHeadIcon(headIconURL)\n    {\n        let headSprite = cc.find('headBgSpriteBtn/maskNode/picSprite', this.node);\n        let srcWidth  = headSprite.width;\n        let srcHeight  = headSprite.height;\n        headSprite.opacity = 0;\n\n        let dirPath =  jsb.fileUtils.getWritablePath() + cc.ss.GlobalConst.IMAGE_CACHE_PATH;\n        let task = RequestTaskFactory.createTask(Task_Type.Image, headIconURL, dirPath, (tex, filePath) => {\n            if (tex)\n            {\n                headSprite.getComponent(cc.Sprite).spriteFrame = new cc.SpriteFrame(tex);\n                headSprite.width = srcWidth;\n                headSprite.height = srcHeight;\n\n                headSprite.runAction(cc.fadeTo(0.8, 255));\n            }\n        });\n\n        task.doDownload();\n    },\n\n    onLoad: function () {\n        this.setControllerName(cc.ss.NameConst.NAME_CONTROLLER_HEAD_ICON);\n        cc.ss.Facade.registerController(this);\n\n        this._bindClickEvent();\n        this._initUIByData();\n    },\n\n    _initUIByData()\n    {\n        this._setupLife(); //初始化体力\n\n        this._setupStarNum(); //初始化星星数字\n\n        this._setupHeadIcon(); //初始化头像\n\n        this._setupTime(); //初始化时间\n    },\n\n    _setupLife()\n    {\n        let lifeNum = cc.ss.lifeSystemMgr.getLife();\n        let lifeHeartList = cc.find('lifeInfoBg/lifeNode', this.node).getChildren();\n        lifeNum = lifeNum > 5 ? 5 : lifeNum;\n\n        lifeHeartList.forEach((heartSp) => { heartSp.getComponent(cc.Sprite).spriteFrame = new cc.SpriteFrame(this.lifeHeartNoneTexture); });\n\n        for (let i = 0; i < lifeNum; i++) lifeHeartList[i].getComponent(cc.Sprite).spriteFrame = new cc.SpriteFrame(this.lifeHeartTexture);\n    },\n\n    _setupStarNum()\n    {\n        let starCount = cc.ss.userInfoCache.userStarNum;\n        cc.find('starInfoBg/starLabel', this.node).getComponent(cc.Label).string = (starCount > 999999999) ? \"999999999+\" : starCount;\n    },\n\n    _setupHeadIcon()\n    {\n        let headIconURL = cc.ss.userInfoCache.headIconURL;\n        if (headIconURL !== \"\" && headIconURL !== undefined && headIconURL !== 'undefined') this._loadHeadIcon(headIconURL);\n    },\n\n    _setupTime()\n    {\n        let isCountingDown = cc.ss.lifeSystemMgr.isCountingDown();\n        cc.find('timeBg', this.node).active = isCountingDown;\n\n        if (isCountingDown) this._setCountTimeLabel(cc.ss.lifeSystemMgr.getNowCountDownSecs());\n    },\n\n    _bindClickEvent()\n    {\n        let headBgSpriteBtn = this.node.getChildByName('headBgSpriteBtn');\n        headBgSpriteBtn.on('click', (event) => {\n            if (this._clickCallback){\n                this._clickCallback();\n                if (cc.ss.localStorage.isSoundOpen(cc.ss.userInfoCache.userId)) cc.ss.audioUtil.playSfx(this.buttonSfx);\n            }\n        });\n    },\n\n    onDestroy: function (){\n        cc.ss.Facade.removeController(this);\n    }\n\n});\n"]}