{"version":3,"sources":["../../../../../../../../../assets/scripts/GameModule/Base/Module/View/Dialog/assets/scripts/GameModule/Base/Module/View/Dialog/DisplayMedalDialog.js"],"names":["MedalDisplayConst","require","UI_Type","cc","Enum","Real","Fake","Share_Type","Download","Friend","TimeLine","None","Class","extends","Component","properties","buttonSfx","AudioClip","_listenerId","_isAppInstallWechat","_shareType","_isAllowClick","initWithData","medalId","medalData","_getMedalConstData","_fitIphoneX","_registerTouchEvent","_bindClickListener","platform","sys","os","ss","nativeUtil","isInstallWechat","node","getChildByName","active","_initPicUIWithData","_initFakePicUIWithData","find","on","ev","_delayAllowUserClick","_playButtonSfx","_captureDisplayMedalDialogImage","destroy","_captureMedalImage","imagePath","console","log","OS_ANDROID","OS_IOS","Facade","sendNotification","TagConst","TAG_CLOSE_DISPLAY_MEDAL_DIALOG","path","getComponent","getNativeImagePathByPlatform","capturePicAndSave","shareWechatFriend","shareTimeline","callback","captureImage","GlobalConst","IMAGE_CACHE_PATH","data","_initDisplaySprite","_initHeadIconAndName","_initDisplayWordLabel","uiType","displaySprite","Sprite","spriteFrame","SpriteFrame","url","raw","Image_Path","nameLabel","RichText","string","Medal_Noti","contentLabel","Medal_Share_Content","isSoundOpen","localStorage","userInfoCache","userId","audioUtil","playSfx","setTimeout","key","Medal_Id","listener","event","EventListener","TOUCH_ONE_BY_ONE","swallowTouches","onTouchBegan","touches","onTouchMoved","onTouchEnded","eventManager","addListener","isIphoneX","uiUtil","isIphoneXsOrAllScreen","newPositionJson","getUserFitIphoneXTopButtonPosition","undefined","closeBtn","posJson","JSON","parse","setPosition","iphoneXPos","onDestroy","removeListener"],"mappings":"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","file":"DisplayMedalDialog.js","sourceRoot":"../../../../../../../../../assets/scripts/GameModule/Base/Module/View/Dialog","sourcesContent":["const MedalDisplayConst = require('MedalDisplayConst');\n\nconst UI_Type = cc.Enum({\n    Real : 0,\n    Fake : 1\n});\n\nconst Share_Type = cc.Enum({\n    Download : 0,\n    Friend : 1,\n    TimeLine : 2,\n    None : 3\n});\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        buttonSfx: cc.AudioClip,\n        _listenerId: -1,\n        _isAppInstallWechat: false,\n        _shareType: Share_Type.None,//分享或炫耀的类型\n        _isAllowClick : true\n    },\n\n    initWithData: function (medalId) {//from = 1 默认为用户中心\n        let medalData = this._getMedalConstData(medalId);\n\n        this._fitIphoneX();\n        this._registerTouchEvent();\n        this._bindClickListener();\n        let platform = cc.sys.os;\n        this._isAppInstallWechat = cc.ss.nativeUtil.isInstallWechat(platform);\n\n        this.node.getChildByName(\"wechatBtn\").active = this._isAppInstallWechat;\n        this.node.getChildByName(\"friendlineBtn\").active = this._isAppInstallWechat;\n\n        this._initPicUIWithData(medalData);\n        this._initFakePicUIWithData(medalData);\n    },\n\n    _bindClickListener: function () {\n        cc.find('wechatBtn', this.node).on('click', (ev) => {\n            if (!this._isAllowClick)return;\n            this._isAllowClick = false;\n            this._delayAllowUserClick();\n\n            this._playButtonSfx();\n            this._shareType = Share_Type.Friend;\n            this._captureDisplayMedalDialogImage();\n        });\n\n\n        cc.find('friendlineBtn', this.node).on('click', (ev) => {\n            if (!this._isAllowClick)return;\n            this._isAllowClick = false;\n            this._delayAllowUserClick();\n\n            this._playButtonSfx();\n            this._shareType = Share_Type.TimeLine;\n            this._captureDisplayMedalDialogImage();\n        });\n\n        cc.find('downloadBtn', this.node).on('click', (ev) => {\n            if (!this._isAllowClick)return;\n            this._isAllowClick = false;\n            this._delayAllowUserClick();\n\n            this._playButtonSfx();\n            this._shareType = Share_Type.Download;\n            this._captureDisplayMedalDialogImage();\n        });\n\n        cc.find('closeBtn', this.node).on('click', (ev) => {\n            this.node.destroy();\n            this._playButtonSfx();\n\n        });\n    },\n\n\n    /**\n     * 截图\n     * @private\n     */\n    _captureDisplayMedalDialogImage()\n    {\n        this._captureMedalImage((imagePath) => {\n            console.log(`[DisplayMedalDialog]本地图片地址:${imagePath}`);\n            let platform = cc.sys.os;\n            if (platform !== cc.sys.OS_ANDROID &&  platform !== cc.sys.OS_IOS) {\n                this.node.destroy();\n                cc.ss.Facade.sendNotification(cc.ss.TagConst.TAG_CLOSE_DISPLAY_MEDAL_DIALOG);\n                return;\n            }\n            let path = this.node.getComponent('CaptureImageComponent').getNativeImagePathByPlatform(platform, imagePath);\n            if (this._shareType === Share_Type.Download) {\n                cc.ss.nativeUtil.capturePicAndSave(platform, path);\n            }else if (this._shareType === Share_Type.Friend) {\n                cc.ss.nativeUtil.shareWechatFriend(platform, path);\n            }else if (this._shareType === Share_Type.TimeLine) {\n                cc.ss.nativeUtil.shareTimeline(platform, path);\n            }\n        });\n    },\n\n\n    /**\n     * 截图\n     * @param callback\n     * @private\n     */\n    _captureMedalImage(callback) { this.node.getComponent('CaptureImageComponent').captureImage(cc.ss.GlobalConst.IMAGE_CACHE_PATH, callback); },\n\n    _initPicUIWithData: function (data) {\n        this._initDisplaySprite(UI_Type.Real, data);\n        this._initHeadIconAndName(UI_Type.Real, data);//0表示真实UI\n        this._initDisplayWordLabel(UI_Type.Real, data);\n    },\n\n    _initFakePicUIWithData : function(data){\n        this._initDisplaySprite(UI_Type.Fake, data);\n        this._initHeadIconAndName(UI_Type.Fake, data);//0表示真实UI\n        this._initDisplayWordLabel(UI_Type.Fake, data);\n    },\n\n    _initDisplaySprite(uiType, data)\n    {\n        let displaySprite = cc.find('picBg/displaySprite', this.node);\n        if (uiType === UI_Type.Fake) displaySprite = cc.find('fakePicBg/displaySprite', this.node);\n\n        displaySprite.getComponent(cc.Sprite).spriteFrame = new cc.SpriteFrame(cc.url.raw(data.Image_Path));\n    },\n\n    _initHeadIconAndName(uiType, data)\n    {\n        let nameLabel = cc.find(\"picBg/userInfoBg/nameBg/nameLabel\", this.node);\n        if (uiType === UI_Type.Fake) nameLabel = cc.find(\"fakePicBg/userInfoBg/nameBg/nameLabel\", this.node);\n\n        nameLabel.getComponent(cc.RichText).string = `<b>${data.Medal_Noti}</b>`;\n    },\n\n    _initDisplayWordLabel(uiType, data)\n    {\n        let contentLabel = cc.find('picBg/medalWordLabel', this.node);\n        if (uiType === UI_Type.Fake) contentLabel = cc.find('fakePicBg/medalWordLabel', this.node);\n        contentLabel.getComponent(cc.RichText).string = `<b>${data.Medal_Share_Content}</b>`;\n    },\n\n    _playButtonSfx() {\n        let isSoundOpen = cc.ss.localStorage.isSoundOpen(cc.ss.userInfoCache.userId);\n        if (isSoundOpen) cc.ss.audioUtil.playSfx(this.buttonSfx);\n    },\n\n    _delayAllowUserClick() { setTimeout(() => { this._isAllowClick = true; }, 100); },\n\n\n    /**\n     * 获取勋章常量数据\n     * @param medalId\n     * @returns {*}\n     * @private\n     */\n    _getMedalConstData(medalId){\n        for(let key in MedalDisplayConst) { if (MedalDisplayConst[key].Medal_Id === medalId ) return  MedalDisplayConst[key]; }\n        return null;\n    },\n\n\n    _registerTouchEvent : function() {\n        let listener = {\n            event : cc.EventListener.TOUCH_ONE_BY_ONE,\n            swallowTouches : true,\n            onTouchBegan : function(touches, event) { return true; },\n            onTouchMoved : function(event) { },\n            onTouchEnded : function(event) { }\n        };\n        this._listenerId = cc.eventManager.addListener(listener, this.node);\n    },\n\n    _fitIphoneX : function ()\n    {\n        let isIphoneX = cc.ss.uiUtil.isIphoneXsOrAllScreen();\n        if(isIphoneX === true){\n            let newPositionJson = cc.ss.localStorage.getUserFitIphoneXTopButtonPosition(cc.ss.userInfoCache.userId);\n            if(newPositionJson !== null && newPositionJson !== undefined && newPositionJson !== \"\"){\n                let closeBtn = cc.find('closeBtn', this.node);\n                let posJson = JSON.parse(newPositionJson);\n                closeBtn.setPosition(posJson.iphoneXPos);\n            }\n\n        }\n    },\n\n    onDestroy :function() { cc.eventManager.removeListener(this._listenerId); }\n\n});\n"]}